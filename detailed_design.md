# アーク新規登録データ変換ツール 詳細設計書

## 1. システム概要

### 1.1 目的
案件取込用レポートとContractListを統合し、アーク新規登録用のCSVファイルを自動生成する。

### 1.2 処理フロー
```
1. 入力ファイルの読み込み
   ├─ 案件取込用レポート（メインデータ）
   └─ ContractList（重複チェック用）

2. データ検証・フィルタリング
   ├─ 重複チェック（ContractListとの照合）
   ├─ 生年月日の異常値除外（1900年以前）
   └─ 必須項目の存在確認

3. データ変換・整形
   ├─ 契約番号への0付与
   ├─ 氏名・カナの空白除去
   ├─ 住所の自動分割
   ├─ 電話番号の振り分け
   ├─ 保証人/緊急連絡人の判定
   └─ 各種固定値の設定

4. 出力ファイル生成
   └─ MMDDアーク新規登録.csv
```

## 2. データマッピング詳細

### 2.1 基本情報
| 出力カラム | 入力元 | 変換ルール |
|-----------|--------|------------|
| 引継番号 | 案件取込用レポート A列「契約番号」 | 先頭に"0"を付与 |
| 契約者氏名 | 案件取込用レポート B列「契約元帳:主契約者」 | 全角スペースを除去 |
| 契約者カナ | 案件取込用レポート C列「主契約者（カナ）」 | 半角スペースを除去、半角カナを全角に変換 |
| 契約者生年月日 | 案件取込用レポート D列「生年月日1」 | 1900年以前は行ごと除外 |

### 2.2 電話番号処理
| 条件 | 処理 |
|------|------|
| 自宅TELあり、携帯TELあり | そのまま格納 |
| 自宅TELあり、携帯TELなし | 自宅TELを携帯TELに移動 |
| 自宅TELなし、携帯TELあり | そのまま格納 |

### 2.3 住所分割ロジック
#### 契約者現住所（物件住所から生成）
- 郵便番号: 正規表現で抽出（\\d{3}-\\d{4}）
- 都道府県: 都道府県リストとマッチング
- 市区町村: 市区町村パターンで抽出
- 住所3: 市区町村以降 + 物件名 + 部屋番号

#### 物件住所・勤務先住所
- 同様のロジックで分割（物件名・部屋番号の結合なし）

### 2.4 保証人/緊急連絡人の判定
```python
if 種別_続柄2 == "保証人":
    → BF～BO列（保証人1）へ格納
elif 種別_続柄2 == "緊急連絡先":
    → BZ～CH列（緊急連絡人1）へ格納
```

### 2.5 金額計算
#### 退去手続き費用
```python
total = 月額賃料 + 管理費 + 駐車場代 + その他費用1
退去手続き費用 = max(total, 70000)
```

### 2.6 固定値設定
| カラム | 固定値 |
|--------|--------|
| 入居ステータス | 入居中 |
| 滞納ステータス | 未精算 |
| 受託状況 | 契約中 |
| 回収口座金融機関CD | 310 |
| 回収口座金融機関名 | GMOあおぞらネット銀行 |
| 回収口座種類 | 普通 |
| 回収口座名義 | アーク株式会社 |
| 契約種類 | バックレント |
| 管理受託日 | 実行日（YYYY/MM/DD） |
| クライアントCD | 10 |
| 水道代 | 0 |
| 共益費 | 0 |
| 更新契約手数料 | 1 |

### 2.7 引継情報の生成
```
●20日～25日頃に督促手数料2,750円or2,970円が加算されることあり。案内注意！！　●入居日：{入居日}
```

## 3. エラーハンドリング

### 3.1 データ検証
- 重複チェック: ContractListに存在する契約番号は除外
- 生年月日チェック: 1900年以前の日付は行ごと除外
- 必須項目チェック: 契約番号、契約者氏名が空の場合は除外

### 3.2 エラー処理
- ファイル読み込みエラー: エラーメッセージを表示して終了
- エンコーディングエラー: CP932で再試行
- 変換エラー: エラー行をログに記録して処理継続

## 4. ファイル仕様

### 4.1 入力ファイル
- エンコーディング: CP932
- 形式: CSV
- ファイル名パターン:
  - 案件取込用レポート: `【東京支店】①案件取込用レポート{YYYYMMDD}.csv`
  - ContractList: `ContractList_*.csv`

### 4.2 出力ファイル
- エンコーディング: CP932
- 形式: CSV
- ファイル名: `{MMDD}アーク新規登録.csv`
- カラム数: 99カラム（サンプルに基づく）

## 5. 実装モジュール構成

### 5.1 モジュール一覧
1. `main.py` - メイン処理
2. `config.py` - 設定・マッピング定義
3. `data_loader.py` - ファイル読み込み
4. `data_validator.py` - データ検証
5. `data_transformer.py` - データ変換
6. `address_splitter.py` - 住所分割
7. `data_exporter.py` - ファイル出力
8. `utils.py` - ユーティリティ関数

### 5.2 処理シーケンス
```python
# main.py
1. 設定読み込み
2. 入力ファイル読み込み
3. 重複チェック・フィルタリング
4. データ変換
5. 出力ファイル生成
```