# アークデータインポートツール - システム設計書

## 1. システム構成

```
┌─────────────────┐    ┌─────────────────┐
│元データファイル1│    │元データファイル2│
│案件取込用レポート│    │ContractList     │
│(40カラム)       │    │(121カラム)      │
└─────────────────┘    └─────────────────┘
           │                        │
           └────────┬───────────────┘
                    │
           ┌─────────▼─────────┐
           │  データ結合・変換   │
           │     エンジン       │
           └─────────┬─────────┘
                    │
           ┌─────────▼─────────┐
           │アーク新規登録CSV   │
           │   (111カラム)     │
           └───────────────────┘
```

## 2. モジュール構成

### 2.1 メインモジュール（main.py）
- プログラム実行のエントリーポイント
- 設定読み込み、処理フロー制御

### 2.2 データ読み込みモジュール（data_loader.py）
- CSVファイル読み込み（CP932対応）
- ファイル存在チェック
- エラーハンドリング

### 2.3 データ変換モジュール（data_transformer.py）
- フィールドマッピング
- データ形式変換
- 固定値設定

### 2.4 データ出力モジュール（data_exporter.py）
- CSV出力（CP932エンコーディング）
- ファイル名生成（日付付き）

### 2.5 設定モジュール（config.py）
- マッピング定義
- 固定値定義
- ファイルパス設定

## 3. データフロー

```
1. 設定読み込み
   ↓
2. 元データファイル読み込み
   - 案件取込用レポート.csv
   - ContractList_YYYYMMDDHHMMSS.csv
   ↓
3. データ結合（利用者番号キー）
   ↓
4. フィールドマッピング変換
   - 基本情報変換
   - 住所分割
   - 日付フォーマット変換
   - 電話番号フォーマット変換
   ↓
5. 固定値設定
   - 銀行情報
   - ステータス情報
   ↓
6. CSV出力
   - 新規登録アーク_YYYYMMDD.csv
```

## 4. 主要なデータ変換ルール

### 4.1 重複チェック・データフィルタリング
- 契約番号（引継ぎ番号）をキーとした既登録案件の除外
- 1700年代等の異常な生年月日データの除外
- 先頭0の補完（CSV連携で消失するため）

### 4.2 基本情報
- 申請者番号 → 利用者番号（先頭0補完）
- 申請者氏名 → 申請者氏名（空白除去、姓名間スペース不要）
- 申請者カナ → 申請者カナ（半角→全角変換、空白削除）
- 生年月日 → 異常値チェック（1700年代等は除外）

### 4.3 電話番号処理
- 自宅TELが空欄で携帯のみ → TEL携帯のみ登録
- 自宅TELのみ → 携帯欄に移動して登録
- 両方ある場合 → それぞれに登録

### 4.4 住所情報（現住所を使用）
- 現住所文字列 → 以下に分割
  - 郵便番号
  - 都道府県
  - 市区町村  
  - 住所3（町名 + 番地 + 物件名 + 号室）

### 4.5 勤務先情報
- 勤務先名 → 勤務先1列の値使用（「不明」もそのまま）
- 勤務先住所・カナ・電話番号2 → 未入力で問題なし

### 4.6 保証人・緊急連絡先処理
- 元データの「保証人」「連絡人」同一列 → 一旦全て「保証人」登録
- 関係性 → すべて「他」で統一
- 後から分類・調整が必要
- 保証人2・緊急連絡人2 → 空白で問題なし

### 4.7 管理会社情報
- 取引先 → 管理会社欄
- 委託先法人ID・登録フラグ → 空白

### 4.8 引継ぎ情報
- 入居日 + 補足文 → 結合して引継ぎ情報欄
- 日付フォーマット: 2024/06/01 → 入居日: 2024年6月1日

### 4.9 固定値
- 金融機関CD → 310
- 金融機関名 → GMOあおぞらネット銀行
- 口座種類 → 普通

## 5. エラーハンドリング
- ファイル不存在エラー
- データフォーマットエラー
- 必須フィールド不足エラー
- エンコーディングエラー