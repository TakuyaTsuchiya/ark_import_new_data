# アーク新規登録データ変換ツール

## 概要
手動で行っていたCSVデータの変換作業を自動化するPythonツールです。
案件取込用レポートとContractListを統合し、アーク新規登録用のCSVファイルを生成します。

## 主な機能
- **自動ファイル検索**: ダウンロードフォルダから最新ファイルを自動取得
- **重複チェック**: ContractListとの照合により既存データを自動除外
- **データ検証**: 1900年以前の異常な生年月日を自動除外
- **住所分割**: 郵便番号、都道府県、市区町村、残り住所に自動分割
- **電話番号処理**: 自宅TELのみの場合は携帯TELに自動移動
- **保証人/緊急連絡人判定**: 種別から自動判定して適切に配置
- **金額計算**: 退去手続き費用の自動計算（最低70,000円保証）

## インストール

```bash
# リポジトリのクローン
git clone https://github.com/TakuyaTsuchiya/ark_import_new_data.git
cd ark_import_new_data

# 依存パッケージのインストール
pip install -r requirements.txt
```

## 使用方法

### 基本的な使い方
```bash
# srcディレクトリに移動
cd src

# 実行（ファイルは自動検索）
python main.py

# ファイルを指定して実行
python main.py --report "案件取込用レポート.csv" --contract-list "ContractList.csv"
```

### コマンドラインオプション
- `--report`: 案件取込用レポートのパス
- `--contract-list`: ContractListのパス
- `--output`: 出力ファイルのパス
- `--downloads-dir`: ダウンロードディレクトリ（デフォルト: C:\Users\user04\Downloads）
- `--output-dir`: 出力ディレクトリ（デフォルト: カレントディレクトリ）
- `--skip-report`: 処理レポートの生成をスキップ

## 必要なファイル

### 入力ファイル
1. **案件取込用レポート**（【東京支店】①案件取込用レポートYYYYMMDD.csv）
   - 契約者情報、物件情報、金額情報などを含む元データ
   - 保証人・緊急連絡人情報（名前2、種別／続柄２列）

2. **ContractList**（ContractList_*.csv）
   - 既存契約の一覧（重複チェック用）

### 出力ファイル
- **MMDDアーク新規登録.csv**: 111列の統合データ
- **processing_report_*.txt**: 処理レポート（オプション）

## データ処理の詳細

### 1. データ検証
- ContractListの「引継番号」との照合で重複を除外
- 生年月日が1900年以前のデータを除外
- 必須項目（契約番号、契約者氏名）の存在確認

### 2. データ変換
- 契約番号の先頭に「0」を付与して引継番号を生成
- 氏名の全角スペース除去、カナの半角→全角変換
- 住所を郵便番号、都道府県、市区町村、残りに自動分割
- 電話番号の条件付き振り分け（自宅のみ→携帯へ）

### 3. 保証人・緊急連絡人処理
- 「種別／続柄２」列で判定（部分一致）
  - 「保証人」を含む → 保証人１として出力
  - 「緊急連絡」を含む → 緊急連絡人１として出力
- データがある行のみ「契約者との関係」に「他」を設定

### 4. 固定値・計算値
- 入居ステータス: 「入居中」
- 滞納ステータス: 「未精算」
- 受託状況: 「契約中」
- 退去手続き費用: max(賃料+管理費+駐車場代+その他費用1, 70000)
- 引継情報: 督促手数料の注意書き＋入居日

## ディレクトリ構造
```
ark_import_new_data/
├── src/              # ソースコード
│   ├── main.py       # メイン処理
│   ├── config.py     # 設定・マッピング定義
│   ├── data_loader.py    # ファイル読み込み
│   ├── data_validator.py # データ検証
│   ├── data_transformer.py # データ変換
│   ├── data_exporter.py  # ファイル出力
│   ├── address_splitter.py # 住所分割
│   └── utils.py      # ユーティリティ関数
├── docs/             # ドキュメント
│   ├── design.md     # 設計書
│   ├── requirements.md # 要求仕様
│   └── manual.txt    # 詳細マニュアル
├── outputs/          # 出力ファイル
├── README.md
├── requirements.txt
└── .gitignore
```

## 技術仕様
- **言語**: Python 3.8+
- **主要ライブラリ**: pandas (2.0.3), chardet (5.2.0)
- **エンコーディング**: CP932（Shift_JIS）
- **対応OS**: Windows
- **処理容量**: 1万件程度のデータに対応

## トラブルシューティング

### エンコーディングエラー
ファイルが正しくCP932でエンコードされているか確認してください。

### カラムが見つからないエラー
元データのカラム名が変更されている可能性があります。`config.py`で定義を確認してください。

### 保証人・緊急連絡人データが取り込まれない
- 「名前2」「種別／続柄２」列が存在するか確認
- 種別に「保証人」または「緊急連絡」が含まれているか確認

## ライセンス
このプロジェクトは内部使用を目的としています。

## 作成者
Takuya Tsuchiya
