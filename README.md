# アーク新規登録データ変換ツール

## 概要
手動で行っていたCSVデータの変換作業を自動化するPythonツールです。案件取込用レポートとContractListを統合し、アーク新規登録用のCSVファイルを生成します。

## 主な機能

### データ処理機能
- **自動ファイル検索**: ダウンロードフォルダから最新ファイルを自動取得
- **重複チェック**: ContractListとの照合により既存データを自動除外
- **データ検証**: 異常な生年月日を空白に修正（レコード保持）
- **住所分割**: 郵便番号、都道府県、市区町村、残り住所に自動分割
- **物件名処理**: 物件名から部屋番号を自動抽出・分離
- **部屋番号正規化**: 小数点表記を整数に変換

### 電話番号処理
- **主契約者**: 自宅TELのみの場合は携帯TELに自動移動
- **保証人・緊急連絡人**: 同様のロジックで電話番号を最適化

### 保証人・緊急連絡人判定
- **保証人**: 「種別／続柄２」に「保証人」が含まれる場合
- **緊急連絡人**: 「種別／続柄２」に「緊急連絡」が含まれる場合
- **法人代表者**: 「種別／続柄２」に「(法)代表者１/」が含まれる場合→緊急連絡人として処理
- **スペース除去**: 保証人・緊急連絡人の氏名から全角・半角スペースを除去

### 手数料フィールド対応
- **AN列（退去済手数料）**: 固定値「0」を設定
- **AO列（入居中滞納手数料）**: 固定値「0」を設定  
- **AP列（入居中正常手数料）**: 固定値「0」を設定

### その他の計算・生成機能
- **金額計算**: 退去手続き費用の自動計算（最低70,000円保証）
- **引継情報生成**: 督促手数料の注意書き＋入居日
- **今日の日付設定**: 管理受託日・申請者確認日に自動設定

## インストール

```bash
# リポジトリのクローン
git clone https://github.com/TakuyaTsuchiya/ark_import_new_data.git
cd ark_import_new_data

# 依存パッケージのインストール
pip install -r requirements.txt
```

## 使用方法

### 基本的な使い方
```bash
# 実行（ファイルは自動検索）
python src/main.py

# ファイルを指定して実行
python src/main.py --report "【東京支店】①案件取込用レポート20250710.csv" --contract-list "ContractList_20250725.csv"

# 出力ファイル名を指定
python src/main.py --output "0728アーク新規登録.csv"
```

### コマンドラインオプション
- `--report`: 案件取込用レポートのパス
- `--contract-list`: ContractListのパス  
- `--output`: 出力ファイル名
- `--downloads-dir`: ダウンロードディレクトリ（デフォルト: C:\Users\user04\Downloads）
- `--output-dir`: 出力ディレクトリ（デフォルト: カレントディレクトリ）
- `--skip-report`: 処理レポートの生成をスキップ

## 必要なファイル

### 入力ファイル
1. **案件取込用レポート**（【東京支店】①案件取込用レポートYYYYMMDD.csv）
   - 契約者情報、物件情報、金額情報などを含む元データ
   - 保証人・緊急連絡人情報（名前2、種別／続柄２列）
   - CP932エンコーディング

2. **ContractList**（ContractList_*.csv）
   - 既存契約の一覧（重複チェック用）
   - 引継番号列を使用して重複判定

### 出力ファイル
- **MMDDアーク新規登録.csv**: 111列の統合データ（CP932エンコーディング）
- **processing_report_*.txt**: 処理レポート（データ統計、エラー情報）

## データ処理の詳細

### 1. データ検証・修正
- **重複除外**: ContractListの「引継番号」との照合で重複レコードを除外
- **生年月日修正**: 1900年以前や異常な値を空白に修正（レコードは保持）
- **必須項目確認**: 契約番号、契約者氏名の存在確認

### 2. データ変換・正規化
- **引継番号生成**: 契約番号の先頭に「0」を付与
- **文字列処理**: 氏名の全角スペース除去、カナの半角→全角変換
- **住所分割**: 都道府県リストを使用した住所の自動分割
- **物件・部屋番号処理**: 
  - 物件名から「123号室」形式の部屋番号を抽出
  - 部屋番号の小数点を整数に変換（例: 101.0 → 101）

### 3. 保証人・緊急連絡人処理
**判定ロジック**:
```
if "保証人" in 種別／続柄２:
    → 保証人１として処理
elif "緊急連絡" in 種別／続柄２ or "(法)代表者１/" in 種別／続柄２:
    → 緊急連絡人１として処理
```

**処理内容**:
- 氏名・カナから全角・半角スペースを除去
- 電話番号の最適化（自宅のみ→携帯へ移動）
- 住所の自動分割
- 契約者との関係に「他」を設定

### 4. 固定値・自動計算
**固定値設定**:
- 入居ステータス: 「入居中」
- 滞納ステータス: 「未精算」  
- 受託状況: 「契約中」
- 回収口座: GMOあおぞらネット銀行
- 契約種類: 「バックレント」
- 手数料フィールド: 「0」（AN、AO、AP列）

**自動計算**:
- 退去手続き費用: `max(賃料 + 管理費 + 駐車場代 + その他費用1, 70000)`
- 引継情報: 督促手数料注意書き + 入居日
- 管理受託日・申請者確認日: 実行日を自動設定

## 最新の改修履歴

### v2.5.0 (2025/07/28)
- **手数料フィールド対応**: AN、AO、AP列の空白問題を修正
- **法人代表者対応**: 「(法)代表者１/」を緊急連絡人として処理
- **物件名処理改善**: 部屋番号の自動抽出・分離機能
- **生年月日処理改善**: 異常値をレコード除外から空白修正に変更
- **電話番号処理拡張**: 保証人・緊急連絡人の電話番号最適化
- **スペース除去機能**: 保証人・緊急連絡人名前の正規化

### v2.4.0
- 保証人・緊急連絡人の自動判定機能
- 住所分割アルゴリズムの改善
- データ検証ロジックの強化

## ディレクトリ構造
```
ark_import_new_data/
├── src/                    # ソースコード
│   ├── main.py            # メイン処理・CLI制御
│   ├── config.py          # 設定・マッピング・固定値定義
│   ├── data_loader.py     # ファイル読み込み・エンコーディング処理
│   ├── data_validator.py  # データ検証・重複チェック
│   ├── data_transformer.py # データ変換・正規化
│   ├── data_exporter.py   # ファイル出力・テンプレート適用
│   ├── address_splitter.py # 住所分割・都道府県判定
│   ├── utils.py           # ユーティリティ関数
│   └── logging.py         # ログ・レポート生成
├── docs/                  # ドキュメント
│   ├── design.md          # 設計書
│   ├── detailed_design.md # 詳細設計
│   ├── requirements.md    # 要求仕様
│   └── manual.txt         # 操作マニュアル
├── outputs/               # 出力ファイル格納
├── README.md             # このファイル
├── requirements.txt      # Python依存パッケージ
├── CLAUDE.md            # Claude Code作業指示
└── .gitignore
```

## 技術仕様

### 動作環境
- **言語**: Python 3.8+
- **主要ライブラリ**: 
  - pandas (2.0.3): データ処理
  - chardet (5.2.0): エンコーディング検出
- **エンコーディング**: CP932（Shift_JIS）
- **対応OS**: Windows
- **処理容量**: 10,000件程度のデータに対応

### パフォーマンス
- **処理時間**: 約1,000件/10秒
- **メモリ使用量**: 約100MB（1,000件処理時）
- **同時処理**: シングルスレッド（データ整合性重視）

## Web版デプロイ計画（今後の予定）

### 技術スタック
- **Frontend**: Streamlit
- **Backend**: 既存のPython処理ロジック
- **Containerization**: Docker
- **Cloud Platform**: Google Cloud Run
- **File Storage**: 一時的なファイル処理（永続化なし）

### 主要機能
- CSVファイルのWebアップロード
- リアルタイム処理進捗表示
- 処理結果のダウンロード
- エラーハンドリング・ユーザーフレンドリーなメッセージ

## トラブルシューティング

### よくある問題

**1. エンコーディングエラー**
```
UnicodeDecodeError: 'cp932' codec can't decode...
```
→ ファイルがCP932でエンコードされているか確認。BOM付きUTF-8の場合は変換が必要。

**2. カラムが見つからないエラー**  
```
KeyError: '契約番号'
```
→ 元データのカラム名が変更された可能性。`config.py`のCOLUMN_MAPPINGSを確認。

**3. 保証人・緊急連絡人データが取り込まれない**
- 「名前2」「種別／続柄２」列の存在確認
- 種別に「保証人」「緊急連絡」「(法)代表者１/」が含まれているか確認

**4. 手数料フィールドが空白になる**
→ v2.5.0で修正済み。AN、AO、AP列は固定値「0」が設定されます。

**5. 部屋番号に小数点が含まれる**
→ v2.5.0で自動修正。「101.0」は「101」に変換されます。

### デバッグ方法
1. `--skip-report`オプションを外してprocessing_report_*.txtを確認
2. 中間ファイルの内容をExcelで開いて目視確認
3. 該当する契約番号でログ出力を検索

## ライセンス
このプロジェクトは内部使用を目的としています。

## 作成者・メンテナー
- **開発者**: Takuya Tsuchiya
- **AI支援**: Claude Code (Anthropic)
- **リポジトリ**: https://github.com/TakuyaTsuchiya/ark_import_new_data

## 貢献・サポート
バグ報告や機能要望は[GitHub Issues](https://github.com/TakuyaTsuchiya/ark_import_new_data/issues)までお願いします。